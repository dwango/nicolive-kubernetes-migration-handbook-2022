<!doctype html><html lang=ja-jp dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kubernetesで稼働するアプリケーションやシステム全体をDataDogでモニタリングします。Service Meshと組み合わせてBFFアプリケーションのメトリクスを可視化します。"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="モニタリング"><meta property="og:description" content="Kubernetesで稼働するアプリケーションやシステム全体をDataDogでモニタリングします。Service Meshと組み合わせてBFFアプリケーションのメトリクスを可視化します。"><meta property="og:type" content="article"><meta property="og:url" content="https://dwango.github.io/nicolive-kubernetes-migration-handbook-2022/docs/performance/monitoring/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-06-05T13:42:11+09:00"><title>モニタリング | ニコニコ生放送 Webフロントエンド Kubernetes移行ハンドブック 2022</title><link rel=manifest href=/nicolive-kubernetes-migration-handbook-2022/manifest.json><link rel=icon href=/nicolive-kubernetes-migration-handbook-2022/favicon.png type=image/x-icon><link rel=stylesheet href=/nicolive-kubernetes-migration-handbook-2022/book.min.fcc3ce6727c2b2b91bc9a518374b77e2097222f7fe4dc0016db675da315da284.css integrity="sha256-/MPOZyfCsrkbyaUYN0t34glyIvf+TcABbbZ12jFdooQ=" crossorigin=anonymous><script defer src=/nicolive-kubernetes-migration-handbook-2022/sw.min.dd2d6bf3c93d9223651db8ea5867f95fed658724b711f7b9e9e1d8aa46a84ebd.js integrity="sha256-3S1r88k9kiNlHbjqWGf5X+1lhyS3Efe56eHYqkaoTr0=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2W6W35K13D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2W6W35K13D",{anonymize_ip:!1})}</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/nicolive-kubernetes-migration-handbook-2022/><span>ニコニコ生放送 Webフロントエンド Kubernetes移行ハンドブック 2022</span></a></h2><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/about/>このHandbookについて</a><ul></ul></li><li><span>ネットワーク</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/network/architecture/>移行前・移行中・移行後のネットワーク設計</a></li></ul></li><li><span>Manifest管理</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/manifest-management/>KubernetesのManifest管理</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-written-by-typescript/>TypeScriptでKubernetesのmanifestを記述する</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-generator-architecture/>TypeScriptでManifestを生成するGeneratorのアーキテクチャ</a></li></ul></li><li><span>Continuous Delivery</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-cd/>Argo CDの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-rollouts/>Argo Rolloutsの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/slack-bot/>Slack Botによる自動化</a></li></ul></li><li><span>Service Mesh (Istio)</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/istio/>BFFとIstio</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/access-log/>アクセスログ</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/traffic-management/>Istio Ingress Gatewayの設定</a></li></ul></li><li><span>Rate Limit</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/global-ratelimit/>Global RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/local-ratelimit/>Local RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/ratelimit-is-unless/>RateLimitで負荷の上昇を防げないパターン</a></li></ul></li><li><span>スケーリング</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/scalability/horizontal-pod-autoscaler/>水平スケール</a></li></ul></li><li><span>負荷</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-test/>負荷試験</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/monitoring/ class=active>モニタリング</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-balancing/>負荷分散</a></li></ul></li><li><span>Docker SwarmからKubernetesへの移行</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/migrate-docker-swarm-to-kubernetes/>通信経路の切り替え</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/application/>アプリケーションの移行</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/menu.svg class=book-icon alt=Menu></label>
<strong>モニタリング</strong>
<label for=toc-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#利用しているモニタリングツール>利用しているモニタリングツール</a></li><li><a href=#bff-サーバーの何を観測するか>BFF サーバーの何を観測するか</a></li><li><a href=#datadogの例>DataDogの例</a></li><li><a href=#モニタリングの次にやること>モニタリングの次にやること</a></li></ul></nav></aside></header><article class=markdown><h1 id=モニタリング>モニタリング
<a class=anchor href=#%e3%83%a2%e3%83%8b%e3%82%bf%e3%83%aa%e3%83%b3%e3%82%b0>#</a></h1><p>言わずもがな、サーバーを持ちサービスを運用する上でモニタリングは必須です。
収集したログや Metrics は不正アクセスや障害の検知、アラートの発報などサービスの運営をする上で必ず必要な情報です。</p><h2 id=利用しているモニタリングツール>利用しているモニタリングツール
<a class=anchor href=#%e5%88%a9%e7%94%a8%e3%81%97%e3%81%a6%e3%81%84%e3%82%8b%e3%83%a2%e3%83%8b%e3%82%bf%e3%83%aa%e3%83%b3%e3%82%b0%e3%83%84%e3%83%bc%e3%83%ab>#</a></h2><p>今回利用しているモニタリングツールは以下の 2 つがあります。</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left>Explorer</th><th style=text-align:left>DashBoard</th></tr></thead><tbody><tr><td style=text-align:left>1</td><td style=text-align:left>Prometheus</td><td style=text-align:left>Grafana</td></tr><tr><td style=text-align:left>2</td><td style=text-align:left>DataDog Agent</td><td style=text-align:left>DataDog</td></tr></tbody></table><p>2 つ存在する理由は、費用的な面とツールの精度を確認するための理由があります。</p><ol><li>DataDog は本番環境で使う。一部の開発環境でも検証可能な状態で利用する。</li><li>上記の DataDog を使わない環境では Prometheus と Grafana で代用する</li><li>2つのツールでモニタリングの精度を比較する（本来は最低でも 3 つあったほうが良い）</li></ol><p>どちらも同じ Metrics を収集できるため単体での Observability の差に大きく違いはありません。
ただ DataLakeとしてDataDogがすでに基盤として存在しているためメインは DataDog に各種情報が集約されています。</p><h2 id=bff-サーバーの何を観測するか>BFF サーバーの何を観測するか
<a class=anchor href=#bff-%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e3%81%ae%e4%bd%95%e3%82%92%e8%a6%b3%e6%b8%ac%e3%81%99%e3%82%8b%e3%81%8b>#</a></h2><p>BFF サーバーにおいて観測する主要なものは以下の表にまとめました。
どれも時系列データとして記録されるため時間変化が分かる状態になっています</p><p>BFF サーバーとして主に観測しているのは次のようなメトリクスになります。</p><p>※ 略語</p><ul><li>rps = Request Per Seconds (1秒間あたりのリクエスト数)</li></ul><table><thead><tr><th style=text-align:left>メトリクス</th><th style=text-align:left>目的</th></tr></thead><tbody><tr><td style=text-align:left>CPU 使用量の最大値、平均値、合計値</td><td style=text-align:left>想定値との比較</td></tr><tr><td style=text-align:left>Memory 使用量の最大値、平均値、合計値</td><td style=text-align:left>メモリリークの観測、想定値との比較</td></tr><tr><td style=text-align:left>HTTP Status Codeの数</td><td style=text-align:left>200, 300, 400, 500 系の観測</td></tr><tr><td style=text-align:left>リクエスト総数に対するStatus Code 500 の数</td><td style=text-align:left>エラー率の観測</td></tr><tr><td style=text-align:left>マイクロサービス間のResponse Time（HTTP, GRPC)</td><td style=text-align:left>ボトルネックの観測</td></tr><tr><td style=text-align:left>マイクロサービス間のrps</td><td style=text-align:left>実効rpsが想定内か観測する</td></tr><tr><td style=text-align:left>Node ごとの replicas</td><td style=text-align:left>スケールアウトやデプロイの変化を観測する</td></tr></tbody></table><p>BFF以外はアクセスログを出力するfluent-bitや、RateLimitを実施しているマイクロサービスも監視する対象となります。</p><h2 id=datadogの例>DataDogの例
<a class=anchor href=#datadog%e3%81%ae%e4%be%8b>#</a></h2><p>具体的な例を紹介します。
DataDog の<a href="https://docs.datadoghq.com/ja/agent/kubernetes/tag/?tab=containerizedagent">Kubernetes タグ抽出</a>では粒度の低いタグとして、
Kubernetes の<a href=https://kubernetes.io/ja/docs/concepts/overview/working-with-objects/common-labels/>Recommend Labels</a>が利用できます。</p><table><thead><tr><th style=text-align:left>DataDog のタグ</th><th style=text-align:left>Kubernetes の Pod Label</th></tr></thead><tbody><tr><td style=text-align:left><code>kube_app_name</code></td><td style=text-align:left><code>app.kubernetes.io/name</code></td></tr><tr><td style=text-align:left><code>kube_app_instance</code></td><td style=text-align:left><code>app.kubernetes.io/instance</code></td></tr><tr><td style=text-align:left><code>kube_app_version</code></td><td style=text-align:left><code>app.kubernetes.io/version</code></td></tr><tr><td style=text-align:left><code>kube_app_component</code></td><td style=text-align:left><code>app.kubernetes.io/component</code></td></tr><tr><td style=text-align:left><code>kube_app_part_of</code></td><td style=text-align:left><code>app.kubernetes.io/part-of</code></td></tr><tr><td style=text-align:left><code>kube_app_managed_by</code></td><td style=text-align:left><code>app.kubernetes.io/managed-by</code></td></tr></tbody></table><p><a href=/03/kubernetes-manifest-written-by-typescript/>TypeScriptでKubernetesのmanifestを記述する</a>で紹介したように、これらのラベルを機械的に付与していくとDataDog上での分解能が飛躍的に向上します。
最も利用頻度の高いタグは<code>kube_app_name</code>と<code>kube_app_version</code>で、これらの2つは非常に重要な役割を担います。</p><p>例えば、新しいPodをデプロイした際に、<code>kube_app_version</code>をフィルタリングのクエリとして利用することで、
どの時刻で新旧のバージョンが入れ替わったのかが可視化されます。</p><p><img src=../deploy-pod.png alt=デプロイ時のダッシュボード></p><p>DashBoardでは他の指標と見比べる事が可能ですので、例えば新しいバージョンにバグが有り、マイクロサービス間の通信のエラー率が高まった場合の観測が可能です。</p><p><img src=../rollback-example.png alt=ロールバックの例></p><p>上記のクエリは次のようになっています。</p><p>Template Parameter</p><ul><li><code>$kube_app_name</code></li><li><code>$kube_namespace</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Total CPU Usage</span>
</span></span><span style=display:flex><span>autosmooth<span style=color:#f92672>(</span>sum:kubernetes.cpu.usage.total<span style=color:#f92672>{</span>$kube_app_name,$kube_namespace<span style=color:#f92672>}</span> by <span style=color:#f92672>{</span>kube_app_version<span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Total</span>
</span></span><span style=display:flex><span>autosmooth<span style=color:#f92672>(</span>sum:kubernetes.memory.usage<span style=color:#f92672>{</span>$kube_app_name,$kube_namespace<span style=color:#f92672>}</span> by <span style=color:#f92672>{</span>kube_app_version<span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Error Resp Rate[%]</span>
</span></span><span style=display:flex><span>a / b * <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## a</span>
</span></span><span style=display:flex><span>  sum:istio.mesh.request.count.total<span style=color:#f92672>{</span>response_code:5*,$kube_app_name,$kube_namespace<span style=color:#f92672>}</span> by <span style=color:#f92672>{</span>response_code,destination_service,request_protocol,kube_app_version<span style=color:#f92672>}</span>.as_count<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## b</span>
</span></span><span style=display:flex><span>  sum:istio.mesh.request.count.total<span style=color:#f92672>{</span>$kube_app_name,$kube_namespace<span style=color:#f92672>}</span> by <span style=color:#f92672>{</span>destination_service,request_protocol<span style=color:#f92672>}</span>.as_count<span style=color:#f92672>()</span>
</span></span></code></pre></div><p>より高度な演算が可能なため、<code>Error Resp Rate[%]</code>のように複数のMetricsを組み合わせることが可能です。</p><h2 id=モニタリングの次にやること>モニタリングの次にやること
<a class=anchor href=#%e3%83%a2%e3%83%8b%e3%82%bf%e3%83%aa%e3%83%b3%e3%82%b0%e3%81%ae%e6%ac%a1%e3%81%ab%e3%82%84%e3%82%8b%e3%81%93%e3%81%a8>#</a></h2><p>更新のたびにDashboardを見に行き、バグがないか確認するはいわゆる「トイル」な仕事になります。
Argo RolloutsではProgressive Deliveryを支援するためのAnalysis機能があり、
PrometheusやDataDogなどの集計データをもとにデプロイを続行するかどうか自動的に判断する事が可能です。</p><ul><li><a href=https://argoproj.github.io/argo-rollouts/analysis/datadog/>https://argoproj.github.io/argo-rollouts/analysis/datadog/</a></li></ul><p>これを導入するためにはまずは信頼できる指標の作成が必要で、
BFFサーバーは何を指標とするかはこれから吟味が必要です。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/dwango/nicolive-kubernetes-migration-handbook-2022/commit/6cee12dd64f9d6074ad4eba9b5ef42eb05ba244d title="Last modified by K.Himeno | June 5, 2022" target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 5, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/dwango/nicolive-kubernetes-migration-handbook-2022/edit/main/content/docs/performance/monitoring.md target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#利用しているモニタリングツール>利用しているモニタリングツール</a></li><li><a href=#bff-サーバーの何を観測するか>BFF サーバーの何を観測するか</a></li><li><a href=#datadogの例>DataDogの例</a></li><li><a href=#モニタリングの次にやること>モニタリングの次にやること</a></li></ul></nav></div></aside></main></body></html>